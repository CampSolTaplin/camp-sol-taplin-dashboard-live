<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Field Trips Admin - Camp Sol Taplin</title>
    <link rel="manifest" href="/static/manifest.json">
    <meta name="theme-color" content="#00A9CE">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="CST Staff App">
    <link rel="apple-touch-icon" href="/static/images/icon-192.png">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&family=DM+Sans:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
    <style>
        .admin-container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 12px;
        }
        .page-title {
            font-family: 'Outfit', sans-serif;
            font-size: 28px;
            font-weight: 700;
        }
        .page-subtitle {
            color: var(--text-muted);
            font-size: 14px;
        }
        .btn-back {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            color: var(--text-muted);
            text-decoration: none;
            font-size: 14px;
            margin-bottom: 20px;
        }
        .btn-back:hover { color: var(--teal); }
        .admin-section {
            background: white;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        .admin-section h3 {
            font-family: 'Outfit', sans-serif;
            font-size: 18px;
            font-weight: 600;
            margin: 0 0 16px 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .venue-table {
            width: 100%;
            border-collapse: collapse;
            font-family: 'DM Sans', sans-serif;
            font-size: 14px;
        }
        .venue-table th {
            text-align: left;
            padding: 10px 12px;
            border-bottom: 2px solid #E5E7EB;
            color: #6B7280;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .venue-table td {
            padding: 10px 12px;
            border-bottom: 1px solid #F3F4F6;
            vertical-align: middle;
        }
        .venue-table tr:hover { background: #F9FAFB; }
        .venue-table .inactive-row { opacity: 0.5; }
        .venue-search {
            padding: 10px 14px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-family: 'DM Sans', sans-serif;
            font-size: 14px;
            width: 280px;
            max-width: 100%;
        }
        .btn-sm {
            padding: 6px 14px;
            border-radius: 6px;
            font-size: 13px;
            font-family: 'DM Sans', sans-serif;
            cursor: pointer;
            border: 1px solid #d1d5db;
            background: white;
            transition: all 0.15s;
        }
        .btn-sm:hover { background: #F3F4F6; }
        .btn-sm-primary {
            background: var(--teal);
            color: white;
            border-color: var(--teal);
        }
        .btn-sm-primary:hover { background: #0B8276; }
        .btn-sm-danger { color: #EF4444; border-color: #FCA5A5; }
        .btn-sm-danger:hover { background: #FEF2F2; }
        .group-day-row {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 0;
            border-bottom: 1px solid #F3F4F6;
            flex-wrap: wrap;
        }
        .group-day-label {
            font-weight: 600;
            min-width: 100px;
            font-size: 14px;
        }
        .group-day-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            flex: 1;
        }
        .group-tag {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            background: #F0FDFA;
            color: #0D9488;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 500;
        }
        .group-tag .remove-btn {
            cursor: pointer;
            font-size: 14px;
            color: #9CA3AF;
            margin-left: 2px;
            line-height: 1;
        }
        .group-tag .remove-btn:hover { color: #EF4444; }
        .add-group-input {
            padding: 6px 10px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 13px;
            width: 150px;
        }
        /* Inline add venue form */
        .add-venue-form {
            display: none;
            padding: 16px;
            background: #F9FAFB;
            border-radius: 8px;
            margin-bottom: 16px;
        }
        .add-venue-form.visible { display: block; }
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 12px;
            margin-bottom: 12px;
        }
        .form-row input {
            padding: 10px 12px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-family: 'DM Sans', sans-serif;
            font-size: 14px;
        }
        .toast {
            position: fixed;
            bottom: 24px;
            right: 24px;
            padding: 12px 20px;
            background: #065F46;
            color: white;
            border-radius: 8px;
            font-family: 'DM Sans', sans-serif;
            font-size: 14px;
            z-index: 9999;
            display: none;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .toast.error { background: #991B1B; }
        .section-toggle-btn {
            margin-left: auto;
            background: none;
            border: 1px solid #E5E7EB;
            border-radius: 6px;
            cursor: pointer;
            padding: 2px 8px;
            font-size: 12px;
            color: #6B7280;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            transition: background 0.15s;
        }
        .section-toggle-btn:hover { background: #F3F4F6; }
        .section-toggle-btn svg { transition: transform 0.3s; }
        .section-collapsible {
            overflow: hidden;
            transition: max-height 0.35s ease, opacity 0.35s ease;
            max-height: 2000px;
            opacity: 1;
        }
        .section-collapsible.collapsed {
            max-height: 0;
            opacity: 0;
        }
        @media (max-width: 768px) {
            .form-row { grid-template-columns: 1fr; }
            .venue-search { width: 100%; }
            .group-day-label { min-width: auto; width: 100%; }
        }
    </style>
</head>
<body>
    {% include '_sidebar.html' %}
    <div class="content" style="padding: 30px 40px;">
        <div class="admin-container">
            <a href="{{ url_for('dashboard') }}" class="btn-back">
                <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"/></svg>
                Back to Dashboard
            </a>
            <div class="page-header">
                <div>
                    <div class="page-title">Field Trips Admin</div>
                    <div class="page-subtitle">Manage venues, group-day assignments, and trip scheduling</div>
                </div>
            </div>

            <!-- Section A: Group-Day Configuration -->
            <div class="admin-section">
                <h3>
                    <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
                    Group-Day Configuration
                </h3>
                <p style="color:#6B7280; font-size:13px; margin-bottom:16px;">Define which groups go on field trips on each day of the week.</p>
                <div id="group-day-container">
                    <div style="color:#9CA3AF;">Loading...</div>
                </div>
                <div style="margin-top:16px; text-align:right;">
                    <button class="btn-sm btn-sm-primary" onclick="saveGroupDays()">Save Group-Day Config</button>
                </div>
            </div>

            <!-- Section B: Trip Assignment Matrix -->
            <div class="admin-section">
                <h3>
                    <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><line x1="3" y1="9" x2="21" y2="9"/><line x1="3" y1="15" x2="21" y2="15"/><line x1="9" y1="3" x2="9" y2="21"/><line x1="15" y1="3" x2="15" y2="21"/></svg>
                    Trip Assignments
                </h3>
                <p style="color:#6B7280; font-size:13px; margin-bottom:16px;">Click any cell to assign or edit a field trip for a group and week.</p>
                <div style="display:flex; align-items:center; gap:12px; margin-bottom:16px; flex-wrap:wrap;">
                    <select id="bus-calc-week" style="padding:8px 12px; border:1px solid #d1d5db; border-radius:8px; font-size:14px;">
                        <option value="1">Week 1</option><option value="2">Week 2</option><option value="3">Week 3</option>
                        <option value="4">Week 4</option><option value="5">Week 5</option><option value="6">Week 6</option>
                        <option value="7">Week 7</option><option value="8">Week 8</option><option value="9">Week 9</option>
                    </select>
                    <button onclick="calculateBuses()" class="btn-sm btn-sm-primary" style="display:inline-flex; align-items:center; gap:6px;">
                        <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="6" width="18" height="13" rx="2"/><path d="M3 10h18M7 15h2M11 15h2"/><circle cx="7" cy="6" r="2"/><circle cx="17" cy="6" r="2"/></svg>
                        Calculate Buses
                    </button>
                </div>
                <div id="admin-ft-matrix" style="overflow-x:auto; -webkit-overflow-scrolling:touch;">
                    <div style="text-align:center; padding:40px; color:#9CA3AF;">Loading matrix...</div>
                </div>
            </div>

            <!-- Section C: Venue Management (collapsible, starts collapsed) -->
            <div class="admin-section">
                <h3 style="display:flex; align-items:center;">
                    <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>
                    <span style="margin-left:8px;">Venue Management</span>
                    <button class="section-toggle-btn" id="venue-section-toggle" onclick="toggleVenueSection()">
                        <svg viewBox="0 0 24 24" width="12" height="12" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
                        <span id="venue-toggle-label">Show</span>
                    </button>
                </h3>
                <div class="section-collapsible collapsed" id="venue-section-body">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px; flex-wrap:wrap; gap:8px;">
                        <input type="text" class="venue-search" id="venue-search" placeholder="Search venues..." oninput="filterVenues()">
                        <div style="display:flex; gap:8px; align-items:center;">
                            <label style="font-size:13px; color:#6B7280; display:flex; align-items:center; gap:4px;">
                                <input type="checkbox" id="show-inactive" onchange="loadVenues()"> Show inactive
                            </label>
                            <button class="btn-sm btn-sm-primary" onclick="toggleAddVenueForm()">+ Add Venue</button>
                        </div>
                    </div>

                    <div class="add-venue-form" id="add-venue-form">
                        <div class="form-row">
                            <input type="text" id="new-venue-name" placeholder="Venue name *">
                            <input type="text" id="new-venue-address" placeholder="Address">
                            <input type="text" id="new-venue-waiver" placeholder="Waiver URL">
                        </div>
                        <div style="display:flex; gap:8px; justify-content:flex-end;">
                            <button class="btn-sm" onclick="toggleAddVenueForm()">Cancel</button>
                            <button class="btn-sm btn-sm-primary" onclick="createVenue()">Create Venue</button>
                        </div>
                    </div>

                    <div style="overflow-x:auto; -webkit-overflow-scrolling:touch;">
                        <table class="venue-table" id="venue-table">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Address</th>
                                    <th>Waiver</th>
                                    <th style="width:120px;">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="venue-tbody">
                                <tr><td colspan="4" style="text-align:center; color:#9CA3AF; padding:30px;">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                    <div id="venue-count" style="margin-top:8px; font-size:12px; color:#9CA3AF;"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
    var allVenues = [];
    var groupDays = {};

    // ---- Init ----
    document.addEventListener('DOMContentLoaded', function() {
        loadGroupDays();
        loadVenues();
        loadAdminMatrix();
    });

    function showToast(msg, isError) {
        var t = document.getElementById('toast');
        t.textContent = msg;
        t.className = 'toast' + (isError ? ' error' : '');
        t.style.display = 'block';
        setTimeout(function() { t.style.display = 'none'; }, 3000);
    }

    // ---- Group Days ----
    function loadGroupDays() {
        fetch('/api/fieldtrips/group-days')
            .then(function(r) { return r.json(); })
            .then(function(data) {
                groupDays = data.group_days || {};
                renderGroupDays();
            });
    }

    function renderGroupDays() {
        var container = document.getElementById('group-day-container');
        var days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'];
        var dayColors = {'Monday':'#3B82F6','Tuesday':'#8B5CF6','Wednesday':'#10B981','Thursday':'#F59E0B','Friday':'#EF4444'};
        var html = '';
        days.forEach(function(day) {
            var groups = groupDays[day] || [];
            html += '<div class="group-day-row" data-day="' + day + '">';
            html += '<div class="group-day-label" style="color:' + (dayColors[day] || '#374151') + ';">' + day + '</div>';
            html += '<div class="group-day-tags">';
            groups.forEach(function(g, idx) {
                html += '<span class="group-tag">' + esc(g);
                html += '<span class="remove-btn" onclick="removeGroupFromDay(\'' + day + '\',' + idx + ')">&times;</span>';
                html += '</span>';
            });
            html += '<input type="text" class="add-group-input" placeholder="+ Add group" onkeydown="if(event.key===\'Enter\')addGroupToDay(\'' + day + '\',this)">';
            html += '</div></div>';
        });
        container.innerHTML = html;
    }

    function addGroupToDay(day, input) {
        var name = input.value.trim();
        if (!name) return;
        if (!groupDays[day]) groupDays[day] = [];
        if (groupDays[day].indexOf(name) >= 0) {
            showToast(name + ' already in ' + day, true);
            return;
        }
        groupDays[day].push(name);
        input.value = '';
        renderGroupDays();
    }

    function removeGroupFromDay(day, idx) {
        if (groupDays[day]) {
            groupDays[day].splice(idx, 1);
            renderGroupDays();
        }
    }

    function saveGroupDays() {
        fetch('/api/fieldtrips/group-days', {
            method: 'PUT',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({group_days: groupDays})
        })
        .then(function(r) { return r.json(); })
        .then(function(data) {
            if (data.success) {
                showToast('Group-day config saved!');
                loadAdminMatrix(); // refresh matrix
            } else {
                showToast('Error: ' + (data.error || 'Unknown'), true);
            }
        });
    }

    // ---- Venues ----
    function loadVenues() {
        var showInactive = document.getElementById('show-inactive').checked;
        fetch('/api/fieldtrips/venues?include_inactive=' + showInactive)
            .then(function(r) { return r.json(); })
            .then(function(data) {
                allVenues = data.venues || [];
                renderVenues();
            });
    }

    function renderVenues() {
        var tbody = document.getElementById('venue-tbody');
        var search = (document.getElementById('venue-search').value || '').toLowerCase();
        var filtered = allVenues.filter(function(v) {
            if (!search) return true;
            return v.name.toLowerCase().indexOf(search) >= 0 ||
                   (v.address || '').toLowerCase().indexOf(search) >= 0;
        });
        var html = '';
        if (filtered.length === 0) {
            html = '<tr><td colspan="4" style="text-align:center; color:#9CA3AF; padding:30px;">No venues found.</td></tr>';
        } else {
            filtered.forEach(function(v) {
                var cls = v.active ? '' : ' class="inactive-row"';
                html += '<tr' + cls + ' id="venue-row-' + v.id + '">';
                html += '<td><strong>' + esc(v.name) + '</strong>' + (v.active ? '' : ' <span style="color:#EF4444; font-size:11px;">(inactive)</span>') + '</td>';
                html += '<td style="color:#6B7280; font-size:13px;">' + esc(v.address || '') + '</td>';
                html += '<td>';
                if (v.waiver_url) {
                    html += '<a href="' + esc(v.waiver_url) + '" target="_blank" style="color:#0D9488; font-size:13px;">View</a>';
                } else {
                    html += '<span style="color:#d1d5db; font-size:13px;">None</span>';
                }
                html += '</td>';
                html += '<td>';
                html += '<button class="btn-sm" style="font-size:12px;" onclick="editVenue(' + v.id + ')">Edit</button> ';
                if (v.active) {
                    html += '<button class="btn-sm btn-sm-danger" style="font-size:12px;" onclick="deactivateVenue(' + v.id + ',\'' + esc(v.name).replace(/'/g, "\\'") + '\')">Deactivate</button>';
                } else {
                    html += '<button class="btn-sm" style="font-size:12px; color:#10B981;" onclick="reactivateVenue(' + v.id + ')">Activate</button>';
                }
                html += '</td></tr>';
            });
        }
        tbody.innerHTML = html;
        document.getElementById('venue-count').textContent = filtered.length + ' of ' + allVenues.length + ' venues';
    }

    function filterVenues() { renderVenues(); }

    function toggleAddVenueForm() {
        var form = document.getElementById('add-venue-form');
        form.classList.toggle('visible');
    }

    function createVenue() {
        var name = document.getElementById('new-venue-name').value.trim();
        var address = document.getElementById('new-venue-address').value.trim();
        var waiver = document.getElementById('new-venue-waiver').value.trim();
        if (!name) { showToast('Venue name is required', true); return; }

        fetch('/api/fieldtrips/venues', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({name: name, address: address, waiver_url: waiver})
        })
        .then(function(r) { return r.json(); })
        .then(function(data) {
            if (data.success) {
                showToast('Venue "' + name + '" created!');
                document.getElementById('new-venue-name').value = '';
                document.getElementById('new-venue-address').value = '';
                document.getElementById('new-venue-waiver').value = '';
                toggleAddVenueForm();
                loadVenues();
            } else {
                showToast('Error: ' + (data.error || 'Unknown'), true);
            }
        });
    }

    function editVenue(id) {
        var v = allVenues.find(function(x) { return x.id === id; });
        if (!v) return;
        var newName = prompt('Venue name:', v.name);
        if (newName === null) return;
        var newAddr = prompt('Address:', v.address || '');
        if (newAddr === null) return;
        var newWaiver = prompt('Waiver URL:', v.waiver_url || '');
        if (newWaiver === null) return;

        fetch('/api/fieldtrips/venues/' + id, {
            method: 'PUT',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({name: newName.trim(), address: newAddr.trim(), waiver_url: newWaiver.trim()})
        })
        .then(function(r) { return r.json(); })
        .then(function(data) {
            if (data.success) {
                showToast('Venue updated!');
                loadVenues();
            } else {
                showToast('Error: ' + (data.error || 'Unknown'), true);
            }
        });
    }

    function deactivateVenue(id, name) {
        if (!confirm('Deactivate venue "' + name + '"? It will no longer appear in dropdowns.')) return;
        fetch('/api/fieldtrips/venues/' + id, {
            method: 'DELETE',
            headers: {'Content-Type': 'application/json'}
        })
        .then(function(r) { return r.json(); })
        .then(function(data) {
            if (data.success) {
                showToast('Venue deactivated');
                loadVenues();
            }
        });
    }

    function reactivateVenue(id) {
        fetch('/api/fieldtrips/venues/' + id, {
            method: 'PUT',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({active: true})
        })
        .then(function(r) { return r.json(); })
        .then(function(data) {
            if (data.success) {
                showToast('Venue reactivated');
                loadVenues();
            }
        });
    }

    // ---- Admin Matrix ----
    var adminFtData = null;

    function loadAdminMatrix() {
        fetch('/api/fieldtrips/matrix')
            .then(function(r) { return r.json(); })
            .then(function(data) {
                adminFtData = data;
                renderAdminMatrix();
            });
    }

    function renderAdminMatrix() {
        var container = document.getElementById('admin-ft-matrix');
        if (!adminFtData) return;

        var weeks = adminFtData.weeks || [];
        var groups = adminFtData.groups || [];
        var dayColors = {'Monday':'#3B82F6','Tuesday':'#8B5CF6','Wednesday':'#10B981','Thursday':'#F59E0B','Friday':'#EF4444'};

        var html = '<table class="ft-matrix-table">';
        html += '<thead><tr><th class="ft-header-cell ft-sticky-col">Group</th>';
        weeks.forEach(function(w) {
            var dates = adminFtData.week_dates[String(w)];
            var dateLabel = '';
            if (dates) {
                var s = new Date(dates[0] + 'T12:00:00');
                dateLabel = '<div class="ft-week-date">' + (s.getMonth()+1) + '/' + s.getDate() + '</div>';
            }
            html += '<th class="ft-header-cell">W' + w + dateLabel + '</th>';
        });
        html += '</tr></thead><tbody>';

        var lastDay = '';
        groups.forEach(function(g) {
            if (g.day !== lastDay) {
                var dc = dayColors[g.day] || '#6B7280';
                html += '<tr><td colspan="' + (weeks.length + 1) + '" class="ft-day-header" style="background:' + dc + ';">' + g.day + '</td></tr>';
                lastDay = g.day;
            }
            html += '<tr>';
            // Group name cell
            html += '<td class="ft-group-cell ft-sticky-col"><div class="ft-group-name">' + esc(g.name) + '</div></td>';

            // Week cells
            var activeWeeks = (adminFtData.weeks_active || {})[g.name] || [1,2,3,4,5,6,7,8,9];
            weeks.forEach(function(w) {
                var isActive = activeWeeks.indexOf(w) >= 0;
                if (!isActive) {
                    html += '<td class="ft-cell ft-cell-disabled"><div class="ft-empty-label">&mdash;</div></td>';
                    return;
                }
                var a = (((adminFtData.assignments || {})[g.name] || {})[g.day] || {})[String(w)];
                var kidCount = (adminFtData.kid_counts[g.name] || {})[String(w)] || 0;
                if (a && a.venue_name) {
                    var cls = a.confirmed ? 'ft-cell-confirmed' : 'ft-cell-pending';
                    html += '<td class="ft-cell ' + cls + '" onclick="adminEditAssignment(\'' + esc(g.name).replace(/'/g, "\\'") + '\',' + w + ',\'' + g.day + '\')" style="cursor:pointer;">';
                    html += '<div class="ft-venue-name" title="' + esc(a.venue_name) + '">' + esc(a.venue_name) + '</div>';
                    var badges = [];
                    if (a.confirmed) badges.push('<span class="ft-badge ft-badge-confirmed">&#10003;</span>');
                    if (kidCount > 0) badges.push('<span class="ft-bus-badge" style="background:#E0F2FE;color:#0369A1;">' + kidCount + '</span>');
                    if (badges.length) html += '<div class="ft-badges">' + badges.join('') + '</div>';
                    if (a.comments) {
                        var shortComment = a.comments.length > 25 ? a.comments.substring(0, 25) + '...' : a.comments;
                        html += '<div class="ft-comment-preview" title="' + esc(a.comments) + '">&#128172; ' + esc(shortComment) + '</div>';
                    }
                    html += '</td>';
                } else {
                    html += '<td class="ft-cell ft-cell-empty" onclick="adminEditAssignment(\'' + esc(g.name).replace(/'/g, "\\'") + '\',' + w + ',\'' + g.day + '\')" style="cursor:pointer;">';
                    if (kidCount > 0) {
                        html += '<div class="ft-kid-count" style="color:#9CA3AF;font-size:11px;">' + kidCount + ' kids</div>';
                    }
                    html += '<div class="ft-empty-label">+</div></td>';
                }
            });
            html += '</tr>';
        });
        html += '</tbody></table>';
        container.innerHTML = html;
    }

    function adminEditAssignment(groupName, week, day) {
        var a = (((adminFtData.assignments || {})[groupName] || {})[day] || {})[String(week)] || {};
        var venues = allVenues.length > 0 ? allVenues : (adminFtData.venues || []);

        // Compute default date from day + week dates
        var dates = adminFtData.week_dates[String(week)];
        var defaultDate = '';
        if (dates) {
            var dayOffs = {'Monday':0,'Tuesday':1,'Wednesday':2,'Thursday':3,'Friday':4};
            var off = dayOffs[day];
            if (off !== undefined) {
                var d = new Date(dates[0] + 'T12:00:00');
                d.setDate(d.getDate() + off);
                defaultDate = d.toISOString().split('T')[0];
            }
        }

        var kidCount = (adminFtData.kid_counts[groupName] || {})[String(week)] || 0;

        // Build a simple modal using prompt-style overlay
        var overlay = document.createElement('div');
        overlay.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:9999;display:flex;align-items:center;justify-content:center;';
        overlay.onclick = function(e) { if (e.target === overlay) document.body.removeChild(overlay); };

        var modal = document.createElement('div');
        modal.style.cssText = 'background:white;border-radius:16px;padding:0;max-width:480px;width:90%;max-height:90vh;overflow-y:auto;';

        var mhtml = '<div style="background:linear-gradient(135deg,#0D9488,#14B8A6);color:white;padding:16px 20px;">';
        mhtml += '<div style="display:flex;justify-content:space-between;align-items:center;">';
        mhtml += '<div><strong style="font-size:16px;">' + esc(groupName) + '</strong><br><span style="opacity:0.8;font-size:12px;">Week ' + week + ' &middot; ' + day + '</span></div>';
        mhtml += '<span onclick="document.body.removeChild(this.closest(\'div[style*=fixed]\'))" style="cursor:pointer;font-size:22px;">&times;</span>';
        mhtml += '</div>';
        if (kidCount > 0) {
            var ctLabel = (adminFtData.has_ct || {})[groupName] ? ' (incl. CT)' : '';
            mhtml += '<div style="margin-top:6px;font-size:13px;opacity:0.9;">' + kidCount + ' campers enrolled' + ctLabel + '</div>';
        }
        mhtml += '</div>';
        mhtml += '<div style="padding:20px;">';

        mhtml += '<label style="display:block;font-size:12px;font-weight:600;color:#6B7280;margin-bottom:4px;">VENUE</label>';
        mhtml += '<select id="admin-ft-venue" style="width:100%;padding:8px;border:1px solid #d1d5db;border-radius:8px;font-size:14px;margin-bottom:12px;">';
        mhtml += '<option value="">-- None --</option>';
        venues.forEach(function(v) {
            if (!v.active && v.id !== a.venue_id) return;
            var sel = a.venue_id === v.id ? ' selected' : '';
            mhtml += '<option value="' + v.id + '"' + sel + '>' + esc(v.name) + '</option>';
        });
        mhtml += '</select>';

        mhtml += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:12px;">';
        mhtml += '<div><label style="display:block;font-size:12px;font-weight:600;color:#6B7280;margin-bottom:4px;">DATE</label>';
        mhtml += '<input type="date" id="admin-ft-date" value="' + (a.trip_date || defaultDate) + '" style="width:100%;padding:8px;border:1px solid #d1d5db;border-radius:8px;font-size:14px;box-sizing:border-box;"></div>';
        mhtml += '<div style="display:flex;align-items:end;padding-bottom:4px;"><label style="display:flex;align-items:center;gap:6px;font-size:14px;cursor:pointer;">';
        mhtml += '<input type="checkbox" id="admin-ft-confirmed" ' + (a.confirmed ? 'checked' : '') + ' style="width:16px;height:16px;accent-color:#10B981;"> Confirmed</label></div>';
        mhtml += '</div>';

        mhtml += '<label style="display:block;font-size:12px;font-weight:600;color:#6B7280;margin-bottom:4px;">COMMENTS</label>';
        mhtml += '<textarea id="admin-ft-comments" rows="2" style="width:100%;padding:8px;border:1px solid #d1d5db;border-radius:8px;font-size:14px;resize:vertical;box-sizing:border-box;">' + esc(a.comments || '') + '</textarea>';

        mhtml += '<div style="display:flex;gap:8px;justify-content:space-between;margin-top:16px;">';
        if (a.id) {
            mhtml += '<button class="btn-sm" id="admin-ft-delete-btn" style="color:#DC2626;border-color:#FECACA;">Delete</button>';
        } else {
            mhtml += '<div></div>';
        }
        mhtml += '<div style="display:flex;gap:8px;">';
        mhtml += '<button class="btn-sm" onclick="document.body.removeChild(this.closest(\'div[style*=fixed]\'))">Cancel</button>';
        mhtml += '<button class="btn-sm btn-sm-primary" id="admin-ft-save-btn">Save</button>';
        mhtml += '</div></div></div>';

        modal.innerHTML = mhtml;
        overlay.appendChild(modal);
        document.body.appendChild(overlay);

        document.getElementById('admin-ft-save-btn').onclick = function() {
            var venueId = document.getElementById('admin-ft-venue').value;
            fetch('/api/fieldtrips/assignments', {
                method: 'PUT',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    group_name: groupName,
                    week: week,
                    day: day,
                    venue_id: venueId || null,
                    trip_date: document.getElementById('admin-ft-date').value || null,
                    confirmed: document.getElementById('admin-ft-confirmed').checked,
                    comments: document.getElementById('admin-ft-comments').value
                })
            })
            .then(function(r) { return r.json(); })
            .then(function(data) {
                if (data.success) {
                    document.body.removeChild(overlay);
                    if (!adminFtData.assignments[groupName]) adminFtData.assignments[groupName] = {};
                    if (!adminFtData.assignments[groupName][day]) adminFtData.assignments[groupName][day] = {};
                    adminFtData.assignments[groupName][day][String(week)] = data.assignment;
                    renderAdminMatrix();
                    showToast('Assignment saved!');
                } else {
                    showToast('Error: ' + (data.error || 'Unknown'), true);
                }
            });
        };

        // Delete handler
        var delBtn = document.getElementById('admin-ft-delete-btn');
        if (delBtn) {
            delBtn.onclick = function() {
                if (!confirm('Delete this assignment?')) return;
                fetch('/api/fieldtrips/assignments/' + a.id, { method: 'DELETE' })
                .then(function(r) { return r.json(); })
                .then(function(data) {
                    if (data.success) {
                        document.body.removeChild(overlay);
                        if (adminFtData.assignments[groupName] && adminFtData.assignments[groupName][day]) {
                            delete adminFtData.assignments[groupName][day][String(week)];
                        }
                        renderAdminMatrix();
                        showToast('Assignment deleted');
                    } else {
                        showToast('Error: ' + (data.error || 'Unknown'), true);
                    }
                });
            };
        }
    }

    function esc(str) {
        if (!str) return '';
        var d = document.createElement('div');
        d.appendChild(document.createTextNode(str));
        return d.innerHTML;
    }

    function calculateBuses() {
        var week = parseInt(document.getElementById('bus-calc-week').value);
        fetch('/api/fieldtrips/calculate-buses', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ week: week })
        })
        .then(function(r) { return r.json(); })
        .then(function(data) {
            if (data.error) { showToast('Error: ' + data.error, true); return; }
            showBusResults(data);
        })
        .catch(function(err) { showToast('Failed: ' + err.message, true); });
    }

    function showBusResults(data) {
        var dayColors = {'Monday':'#3B82F6','Tuesday':'#8B5CF6','Wednesday':'#10B981','Thursday':'#F59E0B','Friday':'#EF4444'};
        var dayOrder = ['Monday','Tuesday','Wednesday','Thursday','Friday'];

        var overlay = document.createElement('div');
        overlay.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:9999;display:flex;align-items:center;justify-content:center;';
        overlay.onclick = function(e) { if (e.target === overlay) document.body.removeChild(overlay); };

        var modal = document.createElement('div');
        modal.style.cssText = 'background:white;border-radius:16px;padding:0;max-width:860px;width:95%;max-height:90vh;overflow-y:auto;';

        var h = '<div style="background:linear-gradient(135deg,#1E40AF,#3B82F6);color:white;padding:20px 24px;">';
        h += '<div style="display:flex;justify-content:space-between;align-items:center;">';
        h += '<div><strong style="font-size:18px;">Bus Allocation</strong><br><span style="opacity:0.8;font-size:13px;">Week ' + data.week + '</span></div>';
        h += '<span onclick="document.body.removeChild(this.closest(\'div[style*=fixed]\'))" style="cursor:pointer;font-size:22px;">&times;</span>';
        h += '</div></div>';
        h += '<div style="padding:20px;">';

        var totalCoach = 0, totalJcc = 0;
        var hasDays = false;

        dayOrder.forEach(function(day) {
            var dayData = (data.days || {})[day];
            if (!dayData || !dayData.venues || dayData.venues.length === 0) return;
            hasDays = true;
            var dc = dayColors[day] || '#6B7280';
            h += '<div style="margin-bottom:16px;">';
            h += '<div style="background:' + dc + ';color:white;padding:8px 14px;border-radius:8px 8px 0 0;font-weight:600;font-size:14px;">' + day + '</div>';
            h += '<table style="width:100%;border-collapse:collapse;font-size:13px;">';
            h += '<thead><tr style="background:#F9FAFB;">';
            h += '<th style="text-align:left;padding:8px;border-bottom:1px solid #E5E7EB;">Venue</th>';
            h += '<th style="text-align:left;padding:8px;border-bottom:1px solid #E5E7EB;">Address</th>';
            h += '<th style="text-align:left;padding:8px;border-bottom:1px solid #E5E7EB;">Groups</th>';
            h += '<th style="text-align:center;padding:8px;border-bottom:1px solid #E5E7EB;">Kids</th>';
            h += '<th style="text-align:center;padding:8px;border-bottom:1px solid #E5E7EB;">People</th>';
            h += '<th style="text-align:center;padding:8px;border-bottom:1px solid #E5E7EB;">Coach</th>';
            h += '<th style="text-align:center;padding:8px;border-bottom:1px solid #E5E7EB;">JCC</th>';
            h += '</tr></thead><tbody>';

            dayData.venues.forEach(function(v) {
                h += '<tr>';
                h += '<td style="padding:8px;border-bottom:1px solid #F3F4F6;font-weight:500;">' + esc(v.venue_name) + '</td>';
                h += '<td style="padding:8px;border-bottom:1px solid #F3F4F6;color:#6B7280;font-size:12px;">' + esc(v.address || '') + '</td>';
                h += '<td style="padding:8px;border-bottom:1px solid #F3F4F6;color:#6B7280;">' + v.groups.join(', ') + '</td>';
                h += '<td style="padding:8px;border-bottom:1px solid #F3F4F6;text-align:center;">' + v.kids + '</td>';
                h += '<td style="padding:8px;border-bottom:1px solid #F3F4F6;text-align:center;font-weight:600;">' + v.total_people + '</td>';
                h += '<td style="padding:8px;border-bottom:1px solid #F3F4F6;text-align:center;">';
                if (v.coach_buses > 0) h += '<span style="background:#DBEAFE;color:#1E40AF;padding:2px 8px;border-radius:12px;font-weight:600;">' + v.coach_buses + '</span>';
                else h += '<span style="color:#D1D5DB;">0</span>';
                h += '</td>';
                h += '<td style="padding:8px;border-bottom:1px solid #F3F4F6;text-align:center;">';
                if (v.jcc_buses > 0) h += '<span style="background:#D1FAE5;color:#065F46;padding:2px 8px;border-radius:12px;font-weight:600;">' + v.jcc_buses + '</span>';
                else h += '<span style="color:#D1D5DB;">0</span>';
                h += '</td></tr>';
            });

            h += '<tr style="background:#F9FAFB;font-weight:600;">';
            h += '<td colspan="5" style="padding:8px;text-align:right;">Day Total:</td>';
            h += '<td style="padding:8px;text-align:center;">' + dayData.totals.coach_buses + '</td>';
            h += '<td style="padding:8px;text-align:center;">' + dayData.totals.jcc_buses + '</td>';
            h += '</tr></tbody></table></div>';

            totalCoach += dayData.totals.coach_buses;
            totalJcc += dayData.totals.jcc_buses;
        });

        if (!hasDays) {
            h += '<div style="text-align:center;padding:30px;color:#9CA3AF;">No field trips assigned for Week ' + data.week + '.</div>';
        } else {
            h += '<div style="background:#F0F9FF;border-radius:12px;padding:16px;display:flex;justify-content:space-around;text-align:center;">';
            h += '<div><div style="font-size:24px;font-weight:700;color:#1E40AF;">' + totalCoach + '</div><div style="font-size:12px;color:#6B7280;">Coach Buses</div></div>';
            h += '<div><div style="font-size:24px;font-weight:700;color:#065F46;">' + totalJcc + '</div><div style="font-size:12px;color:#6B7280;">JCC Buses</div></div>';
            h += '</div>';

            // Action buttons
            h += '<div style="display:flex;justify-content:flex-end;gap:8px;margin-top:16px;padding-top:12px;border-top:1px solid #E5E7EB;">';
            h += '<button id="bus-print-btn" class="btn-sm" style="display:inline-flex;align-items:center;gap:6px;">';
            h += '<svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></svg>';
            h += 'Print</button>';
            h += '<button id="bus-download-btn" class="btn-sm" style="display:inline-flex;align-items:center;gap:6px;">';
            h += '<svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>';
            h += 'Download</button>';
            h += '<button id="bus-email-btn" class="btn-sm btn-sm-primary" style="display:inline-flex;align-items:center;gap:6px;">';
            h += '<svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>';
            h += 'Email</button>';
            h += '</div>';
        }

        h += '</div>';
        modal.innerHTML = h;
        overlay.appendChild(modal);
        document.body.appendChild(overlay);

        // Attach button handlers
        var printBtn = document.getElementById('bus-print-btn');
        if (printBtn) printBtn.onclick = function() { printBusReport(data); };
        var dlBtn = document.getElementById('bus-download-btn');
        if (dlBtn) dlBtn.onclick = function() { downloadBusReport(data); };
        var emailBtn = document.getElementById('bus-email-btn');
        if (emailBtn) emailBtn.onclick = function() { emailBusReport(data); };
    }

    function escHtml(str) {
        if (!str) return '';
        return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
    }

    function generateReportHTML(data) {
        var dayColors = {'Monday':'#3B82F6','Tuesday':'#8B5CF6','Wednesday':'#10B981','Thursday':'#F59E0B','Friday':'#EF4444'};
        var dayOrder = ['Monday','Tuesday','Wednesday','Thursday','Friday'];
        var weekRange = '';
        if (adminFtData && adminFtData.week_dates) {
            var wd = adminFtData.week_dates[String(data.week)];
            if (wd) {
                var s = new Date(wd[0] + 'T12:00:00'), e = new Date(wd[1] + 'T12:00:00');
                var mo = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
                weekRange = mo[s.getMonth()] + ' ' + s.getDate() + ' - ' + mo[e.getMonth()] + ' ' + e.getDate() + ', ' + e.getFullYear();
            }
        }
        var logoUrl = window.location.origin + '/static/images/logo.png';
        var genDate = new Date().toLocaleDateString('en-US', {weekday:'long',year:'numeric',month:'long',day:'numeric'});

        var r = '<!DOCTYPE html><html><head><meta charset="UTF-8">';
        r += '<title>Field Trips Week ' + data.week + ' - Camp Sol Taplin</title>';
        r += '<style>';
        r += '@page{size:landscape;margin:0.5in}';
        r += 'body{font-family:Arial,sans-serif;font-size:11pt;color:#1F2937;margin:20px}';
        r += '.hdr{display:flex;align-items:center;gap:20px;padding-bottom:12px;border-bottom:3px solid #00A9CE;margin-bottom:20px}';
        r += '.hdr img{height:60px} .hdr .t{flex:1} .hdr h1{margin:0;font-size:22pt;color:#00A9CE}';
        r += '.hdr .sub{font-size:12pt;color:#6B7280;margin-top:2px} .hdr .meta{text-align:right;font-size:10pt;color:#9CA3AF}';
        r += '.day{margin-bottom:20px;page-break-inside:avoid}';
        r += '.dayh{padding:6px 12px;color:white;font-weight:bold;font-size:12pt;border-radius:4px 4px 0 0}';
        r += 'table{width:100%;border-collapse:collapse}';
        r += 'th{text-align:left;padding:6px 10px;background:#F9FAFB;border-bottom:2px solid #E5E7EB;font-size:9pt;text-transform:uppercase;letter-spacing:.5px;color:#6B7280}';
        r += 'th.c{text-align:center} td{padding:6px 10px;border-bottom:1px solid #F3F4F6;font-size:10pt;vertical-align:top} td.c{text-align:center}';
        r += '.bc{background:#DBEAFE;color:#1E40AF;padding:1px 8px;border-radius:10px;font-weight:700}';
        r += '.bj{background:#D1FAE5;color:#065F46;padding:1px 8px;border-radius:10px;font-weight:700}';
        r += '.tr{background:#F9FAFB;font-weight:700}';
        r += '.gs{margin-top:20px;background:#F0F9FF;border-radius:8px;padding:16px;display:flex;gap:40px;page-break-inside:avoid}';
        r += '.gs .st{text-align:center} .gs .n{font-size:28pt;font-weight:700} .gs .l{font-size:10pt;color:#6B7280}';
        r += '@media print{body{print-color-adjust:exact;-webkit-print-color-adjust:exact}}';
        r += '</style></head><body>';
        r += '<div class="hdr"><img src="' + logoUrl + '" alt="Logo"><div class="t"><h1>Field Trips &mdash; Week ' + data.week + '</h1>';
        r += '<div class="sub">' + weekRange + '</div></div><div class="meta">Generated: ' + genDate + '</div></div>';

        var gc = 0, gj = 0;
        dayOrder.forEach(function(day) {
            var dd = (data.days || {})[day];
            if (!dd || !dd.venues || dd.venues.length === 0) return;
            var dc = dayColors[day] || '#6B7280';
            r += '<div class="day"><div class="dayh" style="background:' + dc + '">' + day + '</div>';
            r += '<table><thead><tr><th style="width:16%">Venue</th><th style="width:20%">Address</th><th style="width:24%">Groups</th>';
            r += '<th class="c" style="width:8%">Kids</th><th class="c" style="width:10%">People</th><th class="c" style="width:10%">Coach</th><th class="c" style="width:10%">JCC</th></tr></thead><tbody>';
            dd.venues.forEach(function(v) {
                r += '<tr><td><strong>' + escHtml(v.venue_name) + '</strong></td>';
                r += '<td style="color:#6B7280;font-size:9pt">' + escHtml(v.address || '') + '</td>';
                r += '<td style="color:#6B7280">' + v.groups.join(', ') + '</td>';
                r += '<td class="c">' + v.kids + '</td><td class="c"><strong>' + v.total_people + '</strong></td>';
                r += '<td class="c">' + (v.coach_buses > 0 ? '<span class="bc">' + v.coach_buses + '</span>' : '0') + '</td>';
                r += '<td class="c">' + (v.jcc_buses > 0 ? '<span class="bj">' + v.jcc_buses + '</span>' : '0') + '</td></tr>';
            });
            r += '<tr class="tr"><td colspan="5" style="text-align:right">Day Total:</td>';
            r += '<td class="c"><span class="bc">' + dd.totals.coach_buses + '</span></td>';
            r += '<td class="c"><span class="bj">' + dd.totals.jcc_buses + '</span></td></tr>';
            r += '</tbody></table></div>';
            gc += dd.totals.coach_buses;
            gj += dd.totals.jcc_buses;
        });

        r += '<div class="gs">';
        r += '<div class="st"><div class="n" style="color:#1E40AF">' + gc + '</div><div class="l">Coach Buses</div></div>';
        r += '<div class="st"><div class="n" style="color:#065F46">' + gj + '</div><div class="l">JCC Buses</div></div>';
        r += '<div class="st"><div class="n" style="color:#374151">' + (gc + gj) + '</div><div class="l">Total Buses</div></div>';
        r += '</div></body></html>';
        return r;
    }

    function printBusReport(data) {
        var html = generateReportHTML(data);
        var win = window.open('', '_blank', 'width=1100,height=750');
        win.document.write(html);
        win.document.close();
        win.focus();
        setTimeout(function() { win.print(); }, 400);
    }

    function downloadBusReport(data) {
        var html = generateReportHTML(data);
        var blob = new Blob([html], { type: 'text/html;charset=utf-8' });
        var url = URL.createObjectURL(blob);
        var a = document.createElement('a');
        a.href = url;
        a.download = 'FieldTrips-Week' + data.week + '.html';
        document.body.appendChild(a);
        a.click();
        setTimeout(function() { document.body.removeChild(a); URL.revokeObjectURL(url); }, 100);
    }

    function emailBusReport(data) {
        downloadBusReport(data);
        setTimeout(function() {
            var subject = encodeURIComponent('Field Trips - Week ' + data.week);
            var body = encodeURIComponent(
                'Hola Jose,\n\nAqui estan los fieldtrips de la proxima semana. ' +
                'Cualquier duda me dejas saber.\n\nMuchas Gracias'
            );
            window.location.href = 'mailto:info@jabusservice.com,campsoltaplin@marjcc.org?subject=' + subject + '&body=' + body;
        }, 500);
    }

    function toggleVenueSection() {
        var body = document.getElementById('venue-section-body');
        var label = document.getElementById('venue-toggle-label');
        var icon = document.querySelector('#venue-section-toggle svg');
        if (body.classList.contains('collapsed')) {
            body.classList.remove('collapsed');
            label.textContent = 'Hide';
            icon.style.transform = 'rotate(180deg)';
        } else {
            body.classList.add('collapsed');
            label.textContent = 'Show';
            icon.style.transform = 'rotate(0deg)';
        }
    }
    </script>
</body>
</html>
